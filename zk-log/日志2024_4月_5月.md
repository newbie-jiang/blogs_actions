# 2024/04/01

【便携注射机器人项目】

- 增加排气功能

  主界面时候可通过按键SW3（key --） 、SW4 (key ++) 选择排气功能，SW6（sure）可查看排气速度   SW2(start)可启动排气功能

  ![image-20240401175551779](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240401175551779.png)

  ![image-20240401175632732](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240401175632732.png)

  ![image-20240401175717737](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240401175717737.png)

- 增加抽药功能

  主界面时候按下 sw5(back) 抽药启动并显示相应ui，再按一次返回主界面并停止抽药

  ![image-20240401175847916](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240401175847916.png)

- 与傅工测试电机在针管内推进（实验未成功）

  根据受力分析，电机在针管内部由于受到阻力不仅有上下阻力，还有左右阻力，需改善产品结构或使用更大扭矩步进电机

# 2024/04/02

【便携注射机器人项目】

- 做了四种字体界面demo向胡总展示 （楷体，黑体，宋体，华文中宋） 沟通确认UI界面使用 宋体 (该字体无版权)
- 更改所有界面中文字体为 “宋体” 已完成并向胡总演示 通过
- 增加英文字体，开机可选中 / 英文字体 ZH or EN  已完成绝大部分（明天上午可完成所有界面并测试通过）  

后期中英文考虑增加功能（由于不确定flash的大小，后续flash剩余多则可将中英文都保存在flash并可通过用户设置）

- [x] 出厂第一次开机时可根据用户选中的中，英文  写入flash保存，后续开机不再弹出语言选项 
- [x] 按键设置中英文功能

# 2024/04/03

【便携注射机器人项目】

- 完成注射机器人UI英语字体适配并测试无BUG
- 编写注射机器人功能说明书，
- 适配蓝牙控制指令,根据调整界面适配对应指令

# 2024/04/08

【便携注射机器人项目】

- 主界面增加设置选项，可通过按键进入设置菜单，已完成UI部分，配置参数写入falsh以及开机从falsh中获取数据还未完成，明日可完善该功能

  - [x]  中英文语言设置
  - [x] 开机默认 **输血速度，待入量** 设置
  - [x] 开机默认 **输液速度，待入量** 设置
  - [x] 开机默认 **镇痛速度，待入量** 设置

- 规划falsh

  ![image-20240408194202105](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240408194202105.png)

  

  



# 2024/04/09

- 产线装机

# 2024/04/10

- [x] 完成出厂第一次开机时设置中、英文  后续开机不再弹出该页面

- [x] 完成设置界面的中英文切换 且断电不丢失（一套代码兼容中英文版本） 

- [x] 完成设置界面的各模式参数预设（系统默认参数可调，用户不用每次调整速度以及液量到对应值）

  系统参数占用情况

-  500kB-504kB   前20个字节用于保存是否第一次上电标志位 之后40个字节用于保存系统参数（各模式 默认 速度 待入量）
-  504kB-508kB   前十个字节 用于保存出厂是否设置过中英文标志位 



# 2024/04/11

- [x] 上位机接收蓝牙数据较多死机问题，与富芮坤FAE胡工联系 【已解决】
- [x] 更新显示界面 参数由整数更改为小数，UI已更改大部分，串口协议需要更改尚未完成

## 蓝牙发送数据较多卡死问题现象描述：

- 创建运行四个任务，蓝牙调试助手请求数据较少正常，过多会造成死机 ，重启， 蓝牙异常 现象
- 屏蔽掉四个任务之后 请求数据过多正常    

使用原厂demo板测试一致，与硬件电路无关

![image-20240411141436612](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240411141436612.png)



![image-20240411141211712](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240411141211712.png)



## 问题排查：

文件中需要增加 特征2 的数据长度   原长度为20会导致数据阻塞，将缓冲区加大即可         但是屏蔽所有任务数据正常，很奇怪 

![image-20240411155939532](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240411155939532.png)

# 2024/04/12

- [x] 更新显示界面 参数由整数更改为小数，速度，待入量 步进值0.1   UI已更改完成

- [x] 主从机发送接收数据需更改，更新UART协议已完成

# 2024/04/16

## 低功耗测试

##                                                   ---以下测试均在电压6V下进行

## 芯片工作电流说明

富芮坤蓝牙芯片

![image-20240416153404434](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240416153404434.png)

51芯片

![image-20240416154107362](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240416154107362.png)



整机功耗 测试1： 蓝牙芯片可进入低功耗模式，51一直非低功耗    连接屏幕(点亮)

- 进入低功耗模式前   **19.5mA**
- 进入低功耗模式 **11.9mA**

整机功耗 测试2： 蓝牙芯片可进入低功耗模式，51一直非低功耗    不接屏幕

- 进入低功耗模式前 **13.7mA**
- 进入低功耗模式 **6mA**

整机功耗 测试3： 蓝牙芯片可进入低功耗模式，51一直低功耗    连接屏幕(点亮)

- 进入低功耗模式前   **17.3mA**
- 进入低功耗模式 **9.6mA**

整机功耗 测试3： 蓝牙芯片可进入低功耗模式，51一直低功耗    不接屏幕

- 进入低功耗模式前   **11.5mA**
- 进入低功耗模式 **3.8mA**



## 结论

- 富芮坤蓝牙芯片工作电流约为 7.5mA  
- 51 芯片工作电流约为 2.2mA
- 屏幕工作电流约 6mA
- 其他电流约为 3.7mA

## 勘误

- 上述中其他电流消耗异常，检查富芮坤蓝牙芯片工作电流并不准确，富芮坤芯片在配置了ADC的情况下系统进入低功耗电流会增加，实际测整机低功耗范围**0.14mA--0.16mA**   (蓝牙芯片进入低功耗（蓝牙未开启）  ，51芯片进入低功耗)   

- [ ] BUG   在开启低功耗时  使能蓝牙，出现异常错误，该错误在静态库中无法查看，明天和胡工讨论【未解决】
- [ ] 唤醒后屏幕显示异常【未解决】

![image-20240416203229163](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240416203229163.png)

# 2024/04/17

- 唤醒后屏幕显示异常【未解决】

  测试富芮坤demo板唤醒后屏幕显示正常，与我们的板软件逻辑一致

  硬件不同点

  - demo板进入低功耗会复位LCD的RESET脚，会切断电源，
  - 我们的板由于硬件设计未连接RESET且LCD_EN脚由于连接电源无法关闭

  明日验证：通过跳线连接LCD的RESET脚，软件对LCD RESET脚复位验证 

- 进入低功耗无法关闭屏幕，会有6mA左右电流消耗 ，因为与电源相连，关闭则整个系统会断电



- 唤醒后屏幕显示异常【已解决】

  导致唤醒后屏幕显示异常原因，硬件设计上未连接LCD_RESER, 通过跳线连接LCD_RESER,软件验证已通过

  **下一版的电路需要增加LCD_RESET脚的连接**



# 2024/05/06

- [x] 移植FATFS 文件系统 + 外部SPI flash  successful      格式化文件系统  挂载文件系统  读写文件  均验证通过
  - 外部falsh空间使用不完，可通过文件系统存储其他掉电不丢失内容，理论上可同时将外部falsh与内部flash划分出某部分作为文件系统(待验证)
  - （Chip flash speed > external flash speed）
- [ ] FATFS 文件系统 + 内部flash  暂未实现，需重写内部flash操作函数

# 2024/05/07

- FATFS 文件系统 + 内部flash  验证遇到问题  

  - [x] 已经实现flash操作函数且进行读写验证成功(大小100k，读写每个扇区校验数据一致)

  ```
  int8_t my_flash_write(uint8_t *pBuffer, uint32_t address, uint32_t size)
  int8_t my_flash_read(uint8_t *pBuffer,uint32_t address,  uint32_t size)
  ```

  - [ ] 已实现文件系统接口函数，但测试格式化文件系统失败：错误类型如下

  ![image-20240507182206604](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240507182206604.png)

查找相关文档解决方法

- 增加堆栈（无效）
- 增加TASK堆栈（无效）
- 尝试静态内存分配、动态内存分配（无效）
- 减少文件名长度（无效）
- 更改编码类型（无效）





# 2024/05/08

**【VP10-PLUS】**

- [x] 外部flash与内部flash同时挂载文件系统成功

- [x] 更改原系统配置参数地址

- [ ] 外置flash烧录较麻烦，准备移植zmodem协议，上位机拉取bin文件，通过该协议将数据发送至内部flash处理写入spi flash

  **理想状态下烧录时间预估：**

   波特率115200   一帧数据10bit (起始位+数据位+停止位)    每秒发送11kB数据     **1MB大小需要93 S**

   波特率921600  一帧数据10bit (起始位+数据位+停止位)     每秒发送90 kB数据    **1MB大小需要11 S**

  

## FATFS移植后内部flash与RAM占用情况

**总大小如下**

- 1024KB      CHIP FLASH
-  224KB       SRAM     

![](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240508102117508.png)

## 当前flash使用情况与剩余量如下

​         flash占用412.6KB        剩余600KB左右

​          RAM占用122.4KB         剩余100kB左右

![image-20240508153614469](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240508153614469.png)

## 系统配置区域大小

![image-20240508095324235](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240508095324235.png)

- 0x9DE2     FALSH占用39KB

## 当前内部falsh规划

![image-20240508162200214](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240508162200214.png)

**err**

- 从flash中读药物库列表分配内存失败!    需要增加堆栈大小
- 挂载文件系统或格式化失败 err 17，需检查扇区大小，起始地址需要为起始块，扇区数量不能较少



# 2024/05/13

- [x] USB 虚拟U盘挂载成功 读写验证通过（USB MSC）

USB接口连接电脑可直接读写文件(使用内部flash)，log可直接导出

![image-20240513120257942](https://newbie-typora.oss-cn-shenzhen.aliyuncs.com/zhongke/image-20240513120257942.png)

## 2024/05/15

- [x] 重写电机转速算法已完成，由原来的转速0-999ml/h   更改为 转/小时   测试无误
  - 新板存在问题，相同程序驱动电机，力矩减小，且电流与上一版相比较小，电源电路未更改，还未分析其他硬件原理
- [x] 重写下位机串口接收协议已完成（未验证）
  - 上位机的串口协议还未更改，程序无法烧录至富芮坤芯片，测试两个ST link都不能下载程序，明天尝试串口下载程序



## 2024/05/30

问题排查

当上位机通过UART发送数据给下位机，但下位机未能接收到数据时，可能涉及多个潜在问题。这些问题可能包括电压不匹配、物理连接问题、配置错误等。下面是一些需要检查的关键点：

1. **电压匹配**：
   - 确保上位机和下位机的电压水平是兼容的。如果一个设备使用3.3V，另一个使用5V，可能需要电平转换器来匹配信号电平。
2. **物理连接**：
   - 检查UART的连接线（通常是TX、RX和GND）是否正确连接。确保TX线连接到RX线，反之亦然。
   - 检查接线是否松动或有损坏。
3. **串口配置**：
   - 确保两个设备的波特率（bps）、数据位、停止位和奇偶校验配置一致。
   - 如果设备支持，可以查看是否有错误信号或状态指示帮助诊断问题。
4. **软件和固件**：
   - 检查上位机和下位机的软件或固件中是否有bug或配置错误。
   - 确保发送和接收的代码逻辑正确，无遗漏。
5. **干扰和噪音**：
   - 长距离的UART通信可能受到电磁干扰，尝试使用屏蔽线或缩短传输距离。
   - 检查系统周围是否有可能导致干扰的设备。
6. **供电和接地问题**：
   - 确保所有设备的供电稳定且无波动。
   - 检查地线是否正确连接，以防止地回路问题。

通过逐步排查上述问题，通常可以定位到具体的故障点。如果问题仍然存在，可能需要使用逻辑分析仪等工具进一步诊断信号质量和完整性。
