
<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>5.linux下cubeprogrammer下载问题</title>
<style>
body { margin: 0; padding: 0; font-family: sans-serif; background: #f5f5f5; }
#wrapper { max-width: 950px; margin: 0 auto; padding-right: 300px; }
#content {
    background: #fff;
    padding: 40px;
    min-height: 100vh;
    box-shadow: 0 2px 14px #eee;
}
#content img {
    display: block;
    margin: 24px auto;
    max-width: 100%;
    height: auto;
    box-shadow: 0 4px 12px #eee;
    background: #fff;
}
#content pre {
    background: #fafbfc;
    border-radius: 6px;
    padding: 16px;
    margin: 20px 0;
    overflow-x: auto;
    font-size: 16px;
}
#content pre:empty {
    display: none;
}
#content div:empty {
    min-height: 0 !important;
    background: none !important;
}
#toc {
    position: fixed;
    top: 0;
    right: 0;
    width: 270px;
    height: 100vh;
    overflow-y: auto;
    background: #f8f8f8;
    border-left: 1px solid #e0e0e0;
    padding: 32px 16px 32px 24px;
    box-shadow: -3px 0 7px 0 #eee;
    z-index: 100;
}
#toc ul {
    list-style: none;
    padding-left: 0;
    margin: 0;
}
#toc ul ul {
    padding-left: 18px;
    border-left: 2px solid #e0e0e0;
    margin-left: 8px;
}
#toc li {
    margin-bottom: 3px;
}
#toc a {
    color: #222;
    text-decoration: none;
    font-size: 15px;
    transition: color 0.2s;
}
#toc a:hover {
    color: #1a73e8;
}
@media (max-width: 1200px) {
    #toc { display: none; }
    #wrapper { padding-right: 0; }
}
</style>
</head>
<body>
<div id="wrapper">
    <div id="content">
        <h1 id="linuxcubeprogrammer">linux下使用cubeprogrammer下载问题</h1>
<ul>
<li>STM32CubeProgrammer/STM32 ST-LINK 在 Linux 下常见的“无权限访问 USB 设备节点”问题</li>
</ul>
<pre><code>hdj@hdj-virtual-machine:~/zephyrproject/zephyr$ sudo west flash
[sudo] password for hdj: 
sudo: west: command not found
hdj@hdj-virtual-machine:~/zephyrproject/zephyr$ west flash
-- west flash: rebuilding
ninja: no work to do.
-- west flash: using runner stm32cubeprogrammer
      -------------------------------------------------------------------
                        STM32CubeProgrammer v2.20.0                  
      -------------------------------------------------------------------

libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
libusb: error [get_usbfs_fd] libusb couldn't open USB device /dev/bus/usb/002/004, errno=13
libusb: error [get_usbfs_fd] libusb requires write access to USB device nodes
ST-LINK error (DEV_CONNECT_ERR)
FATAL ERROR: command exited with status 1: /usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/bin/STM32_Programmer_CLI --connect 'port=swd reset=HWrst' --download /home/hdj/zephyrproject/zephyr/build/zephyr/zephyr.hex --start
hdj@hdj-virtual-machine:~/zephyrproject/zephyr$ 

</code></pre>
<h2 id="udev">udev 规则文件来源</h2>
<p>STM32CubeProgrammer 的 udev 规则文件通常在<strong>安装路径下的 <code>Drivers/rules/</code> 目录</strong>，</p>
<pre><code>/usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules/
</code></pre>
<pre><code class="language-shell">hdj@hdj-virtual-machine:/usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules$ pwd
/usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules
hdj@hdj-virtual-machine:/usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules$ ls -al
total 56
drwxr-xr-x 2 root root  4096  8月  1 20:06 .
drwxr-xr-x 4 root root  4096  8月  1 20:06 ..
-rw-r--r-- 1 root root   604  7月 19  2024 49-stlinkv2-1.rules
-rw-r--r-- 1 root root   480  7月 19  2024 49-stlinkv2.rules
-rw-r--r-- 1 root root   982  7月 19  2024 49-stlinkv3.rules
-rw-r--r-- 1 root root    97  7月 19  2024 50-usb-conf.rules
-rw-r--r-- 1 root root 21179  7月 19  2024 99-jlink.rules
-rw-r--r-- 1 root root   220  7月 19  2024 Readme.txt
-rw-r--r-- 1 root root     5  7月 19  2024 version.txt

</code></pre>
<p>将这些 <code>.rules</code> 文件<strong>拷贝到系统的 udev 目录</strong>（通常 <code>/etc/udev/rules.d/</code> 或 <code>/lib/udev/rules.d/</code>，推荐后者）</p>
<p>这里我全部拷贝了</p>
<pre><code>sudo cp /usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules/*.rules /etc/udev/rules.d/
sudo cp /usr/local/STMicroelectronics/STM32Cube/STM32CubeProgrammer/Drivers/rules/*.rules /lib/udev/rules.d/
</code></pre>
<h2 id="udev_1">重新加载 udev 规则</h2>
<pre><code>sudo udevadm control --reload-rules
sudo udevadm trigger
</code></pre>
<h2 id="st-link-usb">拔插你的 ST-LINK 或开发板的 USB，再尝试下载</h2>
<pre><code>west flash
</code></pre>
<p><strong>zephyr 下载成功日志</strong></p>
<pre><code>hdj@hdj-virtual-machine:~/zephyrproject/zephyr$ west flash
-- west flash: rebuilding
ninja: no work to do.
-- west flash: using runner stm32cubeprogrammer
      -------------------------------------------------------------------
                        STM32CubeProgrammer v2.20.0                  
      -------------------------------------------------------------------

ST-LINK SN  : 0024001B3033510135393935
ST-LINK FW  : V3J16M7
Board       : STM32H7S78-DK
Voltage     : 3.28V
SWD freq    : 8000 KHz
Connect mode: Under Reset
Reset mode  : Hardware reset
Device ID   : 0x485
Revision ID : Rev Y
Device name : STM32H7RSxx
Flash size  : 64 KBytes (default)
Device type : MCU
Device CPU  : Cortex-M7
BL Version  : 0xE3



Opening and parsing file: zephyr.hex


Memory Programming ...
  File          : zephyr.hex
  Size          : 19.13 KB 
  Address       : 0x08000000


Erasing memory corresponding to segment 0:
Erasing internal memory sectors [0 2]
Download in Progress:
[==================================================] 100% 

File download complete
Time elapsed during download operation: 00:00:00.529

RUNNING Program ... 
  Address:      : 0x8000000
Application is running, Please Hold on...
Start operation achieved successfully

</code></pre>
<p>参考</p>
<p>https://community.st.com/t5/stm32cubeprogrammer-mcus/error-connecting-with-st-link-in-linux/m-p/691460#M6688</p>
    </div>
</div>
<div id="toc">
    <div style="font-weight:bold;margin-bottom:12px;">目录</div>
    <div class="toc">
<ul>
<li><a href="#linuxcubeprogrammer">linux下使用cubeprogrammer下载问题</a><ul>
<li><a href="#udev">udev 规则文件来源</a></li>
<li><a href="#udev_1">重新加载 udev 规则</a></li>
<li><a href="#st-link-usb">拔插你的 ST-LINK 或开发板的 USB，再尝试下载</a></li>
</ul>
</li>
</ul>
</div>

</div>
</body>
</html>
